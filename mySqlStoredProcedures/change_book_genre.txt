CREATE DEFINER=`root`@`localhost` PROCEDURE `change_book_genre`(
book_id INT,
genres TEXT
)
BEGIN

    #first delete all genres of specified book from media_genre; easier to delete all and then insert every marked 'genre' than trying to
    #see if genre already exists in table, as well as deleting those from table that are not mentioned in new 'genres' string
    DELETE
    FROM media_genre
    WHERE media_genre.media_type_id = 1 AND media_genre.media_id = book_id;
    

	SET @stringLen = LENGTH(genres);
	insertionLoop: LOOP
        SET @genreName = LOWER(SUBSTRING_INDEX(genres, ',', 1));
        SET @genreID = (SELECT genre_id FROM genre_types WHERE genre_name = @genreName);
        SET @substringLen = LENGTH(@genreName);
        
        INSERT INTO media_genre(genre_id, media_type_id, media_id)
        VALUES(@genreID, 1, book_id);
        
        #the +2 is to skip the last letter of the substring along with the comma
        SET genres = MID(genres, @substringLen + 2, @stringLen);

        IF genres IS NULL OR genres = '' THEN
			LEAVE insertionLoop;
		END IF;
    END LOOP insertionLoop;

END